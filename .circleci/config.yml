version: 2.1

# Define reusable executors
executors:
  node-executor:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/notes-ext

# Define jobs
jobs:
  # Install dependencies
  install:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "yarn.lock" }}
            - v1-dependencies-
      - run:
          name: Install Dependencies
          command: yarn install --immutable
      - save_cache:
          paths:
            - .yarn/cache
            - .yarn/unplugged
            - node_modules
          key: v1-dependencies-{{ checksum "yarn.lock" }}
      - persist_to_workspace:
          root: ~/notes-ext
          paths:
            - .yarn
            - node_modules

  # Linting jobs
  lint-typescript:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/notes-ext
      - run:
          name: TypeScript Type Check
          command: yarn lint:ts

  lint-eslint:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/notes-ext
      - run:
          name: ESLint Check
          command: yarn lint:eslint

  lint-stylelint:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/notes-ext
      - run:
          name: Stylelint Check
          command: yarn lint:style

  # Format check
  format-check:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/notes-ext
      - run:
          name: Prettier Format Check
          command: yarn format:check

  # Build job
  build:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/notes-ext
      - run:
          name: Build Extension
          command: yarn build
      - store_artifacts:
          path: dist
          destination: build-output
      - persist_to_workspace:
          root: ~/notes-ext
          paths:
            - dist

  # Test job (placeholder for future tests)
  test:
    executor: node-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/notes-ext
      - run:
          name: Run Tests
          command: echo "Tests will be added in the future"

# Define workflows
workflows:
  version: 2
  build-and-test:
    jobs:
      - install
      - lint-typescript:
          requires:
            - install
      - lint-eslint:
          requires:
            - install
      - lint-stylelint:
          requires:
            - install
      - format-check:
          requires:
            - install
      - build:
          requires:
            - install
            - lint-typescript
            - lint-eslint
            - lint-stylelint
            - format-check
      - test:
          requires:
            - build
